<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Upload Files Dashboard</title>
    <!--
      ‡πÉ‡∏ä‡πâ Tailwind CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞ responsive
      ‡πÅ‡∏•‡∏∞ Google Fonts ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!--
      ‡πÉ‡∏ä‡πâ PapaParse library ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏à‡∏≤‡∏Å Google Sheet ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Dashboard -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">üìä Line Upload Files Dashboard</h1>
            <p id="last-update-text" class="text-slate-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
        </header>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (KPI Cards) -->
        <div id="kpi-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Card 1: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-start transition-transform transform hover:scale-105">
                <div class="bg-blue-100 rounded-full p-4 mr-5">
                    <svg class="w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 5.25 6h.008a2.25 2.25 0 0 1 2.242 2.135 48.424 48.424 0 0 0-1.123-.08M15.75 9h.008a2.25 2.25 0 0 1 2.242 2.135 48.424 48.424 0 0 0-1.123-.08M15.75 9a2.25 2.25 0 0 0-2.25-2.25h-4.5a2.25 2.25 0 0 0-2.25 2.25m4.5 0v.75m3.75-3.75A2.25 2.25 0 0 0 13.5 6a2.25 2.25 0 0 0-2.25 2.25m10.5 0a48.546 48.546 0 0 0-9-1.583A2.25 2.25 0 0 0 9 6.108V6.75a2.25 2.25 0 0 0 2.25 2.25m4.5 0h.008a2.25 2.25 0 0 1 2.242 2.135m-11.218 0c-.065.21-.1.433-.1.664a2.25 2.25 0 0 0 .1.664m5.8 0c.065-.21.1-.433.1-.664a2.25 2.25 0 0 0-.1-.664M3.75 7.5h.008v.008H3.75V7.5Zm.375 0a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25V7.5Z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="kpi-total-rows" class="text-2xl font-bold text-slate-700">...</p>
                </div>
            </div>
            <!-- Card 2: ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (JPG) -->
            <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-start transition-transform transform hover:scale-105">
                <div class="bg-green-100 rounded-full p-4 mr-5">
                     <svg class="w-8 h-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (.jpg)</p>
                    <p id="kpi-total-jpg" class="text-2xl font-bold text-slate-700">...</p>
                </div>
            </div>
            <!-- Card 3: Presentation (PPTX) -->
            <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-start transition-transform transform hover:scale-105">
                <div class="bg-yellow-100 rounded-full p-4 mr-5">
                    <svg class="w-8 h-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h1.5v.154c0 .621.504 1.125 1.125 1.125h12c.621 0 1.125-.504 1.125-1.125V19.5h1.5m-17.25 0h.008v.008H3.375v-.008Zm17.25 0h.008v.008h-.008v-.008Zm0 0h.008v.008h-.008v-.008ZM5.625 5.25h12.75a2.25 2.25 0 0 1 2.25 2.25v6.75a2.25 2.25 0 0 1-2.25 2.25H5.625a2.25 2.25 0 0 1-2.25-2.25V7.5a2.25 2.25 0 0 1 2.25-2.25Z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Presentation (.pptx)</p>
                    <p id="kpi-total-pptx" class="text-2xl font-bold text-slate-700">...</p>
                </div>
            </div>
             <!-- Card 4: PDF -->
            <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-start transition-transform transform hover:scale-105">
                <div class="bg-red-100 rounded-full p-4 mr-5">
                   <!-- (UPDATED) Changed icon and color for PDF -->
                   <svg class="w-8 h-8 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                   </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">PDF (.pdf)</p>
                    <p id="kpi-total-pdf" class="text-2xl font-bold text-slate-700">...</p>
                </div>
            </div>
        </div>
        
         <!-- Storage Usage Card -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-slate-700">Storage Usage</h3>
                <p id="storage-text" class="text-sm font-medium text-slate-500">...</p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="storage-progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
        <main>
             <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Filter -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-6 flex flex-col sm:flex-row gap-4 items-center">
                <h3 class="text-lg font-semibold text-slate-600">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</h3>
                <div class="w-full sm:w-auto">
                    <label for="filter-file-type" class="sr-only">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå</label>
                    <select id="filter-file-type" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
                <div class="w-full sm:w-auto">
                    <label for="filter-sender" class="sr-only">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</label>
                    <select id="filter-sender" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div id="dashboard-container" class="overflow-x-auto">
                    <div id="loading-indicator" class="p-8 text-center text-gray-500 flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                    </div>
                    <table id="data-table" class="w-full text-sm text-left text-gray-600 hidden">
                        <thead id="table-head" class="text-xs text-white uppercase bg-slate-700"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                    <div id="error-message" class="p-8 text-center text-red-500 hidden"></div>
                </div>
            </div>

             <!-- Pagination Controls -->
            <div id="pagination-controls" class="bg-white rounded-xl shadow-md p-4 mt-6 flex justify-between items-center flex-wrap gap-4 hidden">
                <!-- Rows per page selector -->
                <div>
                    <label for="rows-per-page" class="text-sm font-medium text-gray-700 mr-2">‡πÅ‡∏™‡∏î‡∏á:</label>
                    <select id="rows-per-page" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                    </select>
                    <span class="text-sm font-medium text-gray-700 ml-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</span>
                </div>

                <!-- Pagination navigation -->
                <div class="flex items-center gap-2">
                    <button id="prev-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    </button>
                    <span id="page-info" class="text-sm text-gray-700 font-medium"></span>
                    <button id="next-page-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    </button>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>Designed by Krairat Komdee, MD. @2025</p>
        </footer>
    </div>

    <script>
        const sheetId = '1J807JFc4XyLd930wGatmqYi0gcPN0gfH6GHa_9zhfuE';
        const sheetName = 'Sheet1';
        const googleSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;

        // Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        const timestampKey = 'Timestamp';
        const fileNameKey = 'File Name'; 
        const fileTypeKey = 'File Type';
        const senderKey = 'Sender';
        const downloadLinkKey = 'Download Link';
        const fileSizeKey = 'File Size';

        // Global states
        let allData = [];
        let filteredAndSortedData = [];
        let currentSort = { key: timestampKey, order: 'desc' };
        let currentPage = 1;
        let rowsPerPage = 15;

        // DOM Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const dataTable = document.getElementById('data-table');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const errorMessage = document.getElementById('error-message');
        const fileTypeFilter = document.getElementById('filter-file-type');
        const senderFilter = document.getElementById('filter-sender');
        const paginationControls = document.getElementById('pagination-controls');
        const rowsPerPageSelector = document.getElementById('rows-per-page');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        const lastUpdateText = document.getElementById('last-update-text');
        const storageText = document.getElementById('storage-text');
        const storageProgressBar = document.getElementById('storage-progress-bar');

        const formatNumber = (number) => new Intl.NumberFormat('th-TH').format(number);
        
        function fetchData() {
            Papa.parse(googleSheetUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    allData = results.data;
                    
                    if (allData.length > 0) {
                        const sortedByDate = [...allData].sort((a, b) => new Date(b[timestampKey]) - new Date(a[timestampKey]));
                        const latestTimestamp = sortedByDate[0][timestampKey];
                        const date = new Date(latestTimestamp);
                        const formattedDate = date.toLocaleString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        lastUpdateText.textContent = `Last Update: ${formattedDate}`;
                    } else {
                        lastUpdateText.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    }

                    loadingIndicator.classList.add('hidden');
                    populateFilters(allData);
                    processAndRenderData({ resetPage: true });
                    dataTable.classList.remove('hidden');
                    paginationControls.classList.remove('hidden');
                },
                error: (error) => {
                    console.error('Error fetching data:', error);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏î‡πâ (${error.message})`
                    errorMessage.classList.remove('hidden');
                    lastUpdateText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ';
                }
            });
        }

        function populateFilters(data) {
            const uniqueFileTypes = [...new Set(data.map(row => row[fileTypeKey]).filter(Boolean))].sort();
            const uniqueSenders = [...new Set(data.map(row => row[senderKey]).filter(Boolean))].sort();
            uniqueFileTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                fileTypeFilter.appendChild(option);
            });
            uniqueSenders.forEach(sender => {
                const option = document.createElement('option');
                option.value = sender;
                option.textContent = sender;
                senderFilter.appendChild(option);
            });
        }
        
        function handleSortClick(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.key = key;
                currentSort.order = 'asc';
            }
            processAndRenderData();
        }

        function processAndRenderData(options = {}) {
            if (options.resetPage) { currentPage = 1; }

            // 1. Filter
            const selectedType = fileTypeFilter.value;
            const selectedSender = senderFilter.value;
            let processedData = allData;
            if (selectedType) { processedData = processedData.filter(row => row[fileTypeKey] === selectedType); }
            if (selectedSender) { processedData = processedData.filter(row => row[senderKey] === selectedSender); }
            
            // 2. Sort
            processedData.sort((a, b) => {
                const valA = a[currentSort.key] || '';
                const valB = b[currentSort.key] || '';
                let comparison = (currentSort.key === timestampKey) ? new Date(valA) - new Date(valB) : valA.localeCompare(valB, 'th');
                return currentSort.order === 'asc' ? comparison : -comparison;
            });

            filteredAndSortedData = processedData;

            // 3. Update KPIs
            calculateAndDisplayKPIs(filteredAndSortedData);

            // 4. Render current page
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const totalPages = Math.ceil(filteredAndSortedData.length / rowsPerPage);
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredAndSortedData.slice(startIndex, endIndex);
            displayTableData(pageData);
            updatePaginationControls(totalPages);
        }

        function calculateAndDisplayKPIs(data) {
            // Cards calculation
            const totalRows = data.length;
            const totalJpg = data.filter(row => row[fileTypeKey] && row[fileTypeKey].trim().toLowerCase() === 'jpg').length;
            const totalPptx = data.filter(row => row[fileTypeKey] && row[fileTypeKey].trim().toLowerCase() === 'pptx').length;
            const totalPdf = data.filter(row => row[fileTypeKey] && row[fileTypeKey].trim().toLowerCase() === 'pdf').length;

            document.getElementById('kpi-total-rows').textContent = formatNumber(totalRows) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            document.getElementById('kpi-total-jpg').textContent = formatNumber(totalJpg) + ' ‡πÑ‡∏ü‡∏•‡πå';
            document.getElementById('kpi-total-pptx').textContent = formatNumber(totalPptx) + ' ‡πÑ‡∏ü‡∏•‡πå';
            document.getElementById('kpi-total-pdf').textContent = formatNumber(totalPdf) + ' ‡πÑ‡∏ü‡∏•‡πå';

            // Storage calculation logic
            const baseStorageGB = 1.23; // ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            
            const loggedFilesSizeMB = data.reduce((sum, row) => {
                const sizeString = row[fileSizeKey] || '0 KB';
                const sizeParts = sizeString.split(' ');
                let sizeInMB = 0;
                if (sizeParts.length === 2) {
                    const sizeValue = parseFloat(sizeParts[0].replace(/,/g, ''));
                    const sizeUnit = sizeParts[1].toUpperCase();
                    if (sizeUnit === 'KB') {
                        sizeInMB = sizeValue / 1024;
                    } else if (sizeUnit === 'MB') {
                        sizeInMB = sizeValue;
                    } else if (sizeUnit === 'GB') {
                        sizeInMB = sizeValue * 1024;
                    }
                }
                return sum + sizeInMB;
            }, 0);

            const loggedFilesSizeGB = loggedFilesSizeMB / 1024;
            const totalSizeGB = baseStorageGB + loggedFilesSizeGB; // ‡∏ô‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
            const totalDriveSpaceGB = 15;
            const percentageUsed = (totalSizeGB / totalDriveSpaceGB) * 100;

            storageText.textContent = `${totalSizeGB.toFixed(2)} GB / ${totalDriveSpaceGB} GB Used`;
            storageProgressBar.style.width = `${Math.min(percentageUsed, 100)}%`;
             if(percentageUsed > 85) {
                storageProgressBar.classList.remove('bg-indigo-600', 'bg-yellow-500');
                storageProgressBar.classList.add('bg-red-600');
            } else if (percentageUsed > 60) {
                storageProgressBar.classList.remove('bg-indigo-600', 'bg-red-600');
                storageProgressBar.classList.add('bg-yellow-500');
            } else {
                storageProgressBar.classList.remove('bg-yellow-500', 'bg-red-600');
                storageProgressBar.classList.add('bg-indigo-600');
            }
        }

        function displayTableData(data) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            const visibleHeaders = [timestampKey, fileNameKey, senderKey];
            const headerRow = document.createElement('tr');
            visibleHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3';
                if (headerText === timestampKey || headerText === fileNameKey) {
                    th.classList.add('cursor-pointer', 'hover:bg-slate-600', 'transition-colors');
                    th.addEventListener('click', () => handleSortClick(headerText));
                    th.textContent = headerText === timestampKey ? '‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ' : headerText + ' ';
                    if (currentSort.key === headerText) {
                        th.innerHTML += currentSort.order === 'desc' ? '‚ñº' : '‚ñ≤';
                    }
                } else {
                    th.textContent = headerText;
                }
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white border-b hover:bg-slate-50' : 'bg-slate-50 border-b hover:bg-slate-100';
                visibleHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 font-medium';
                    if (header === fileNameKey && row[downloadLinkKey]) {
                        const link = document.createElement('a');
                        link.href = row[downloadLinkKey];
                        link.textContent = row[header] || '';
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-blue-600 hover:underline';
                        td.appendChild(link);
                    } else {
                        td.textContent = row[header] || '';
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        function updatePaginationControls(totalPages) {
             pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages || 1}`;
             prevPageBtn.disabled = currentPage <= 1;
             nextPageBtn.disabled = currentPage >= totalPages;
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            fileTypeFilter.addEventListener('change', () => processAndRenderData({ resetPage: true }));
            senderFilter.addEventListener('change', () => processAndRenderData({ resetPage: true }));
            
            rowsPerPageSelector.addEventListener('change', (e) => {
                rowsPerPage = parseInt(e.target.value, 10);
                processAndRenderData({ resetPage: true });
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) { currentPage--; renderCurrentPage(); }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredAndSortedData.length / rowsPerPage);
                if (currentPage < totalPages) { currentPage++; renderCurrentPage(); }
            });
        });
    </script>

</body>
</html>

